import { useState, useRef } from 'react';
import { useForm } from 'react-hook-form';
import { Upload, Save, RefreshCw } from 'lucide-react';
import { useTheme } from '../contexts/ThemeContext';
import api from '../services/api';

interface SettingsForm {
  companyName: string;
  primaryColor: string;
  secondaryColor: string;
  accentColor: string;
}

export default function SettingsPage() {
  const { settings, refreshSettings } = useTheme();
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [uploadingLogo, setUploadingLogo] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<SettingsForm>({
    defaultValues: {
      companyName: settings.companyName,
      primaryColor: settings.primaryColor,
      secondaryColor: settings.secondaryColor,
      accentColor: settings.accentColor,
    },
  });

  const onSubmit = async (data: SettingsForm) => {
    try {
      setLoading(true);
      setMessage('');
      await api.patch('/settings', data);
      await refreshSettings();
      setMessage('Configuración actualizada correctamente');
    } catch (error: any) {
      setMessage(error.response?.data?.message || 'Error al actualizar la configuración');
    } finally {
      setLoading(false);
    }
  };

  const handleLogoUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // Validar tipo de archivo
    if (!file.type.startsWith('image/')) {
      setMessage('Por favor selecciona una imagen válida');
      return;
    }

    // Validar tamaño (5MB)
    if (file.size > 5 * 1024 * 1024) {
      setMessage('La imagen no debe superar los 5MB');
      return;
    }

    try {
      setUploadingLogo(true);
      setMessage('');

      const formData = new FormData();
      formData.append('logo', file);

      await api.post('/settings/logo', formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      });

      await refreshSettings();
      setMessage('Logo actualizado correctamente');
    } catch (error: any) {
      setMessage(error.response?.data?.message || 'Error al subir el logo');
    } finally {
      setUploadingLogo(false);
    }
  };

  return (
    <div>
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Configuración</h1>
        <p className="text-gray-600 mt-2">
          Personaliza la apariencia de tu aplicación
        </p>
      </div>

      {message && (
        <div className={`mb-6 p-4 rounded-lg ${
          message.includes('Error') || message.includes('error')
            ? 'bg-red-100 text-red-700 border border-red-400'
            : 'bg-green-100 text-green-700 border border-green-400'
        }`}>
          {message}
        </div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Logo */}
        <div className="card">
          <h2 className="text-xl font-semibold text-gray-900 mb-4">Logo de la Empresa</h2>
          
          <div className="mb-4">
            {settings.logoUrl ? (
              <div className="flex items-center justify-center p-6 bg-gray-50 rounded-lg">
                <img
                  src={`http://localhost:3000${settings.logoUrl}`}
                  alt="Logo actual"
                  className="max-h-32 object-contain"
                />
              </div>
            ) : (
              <div className="flex items-center justify-center p-6 bg-gray-50 rounded-lg">
                <div className="text-center text-gray-500">
                  <Upload className="w-12 h-12 mx-auto mb-2" />
                  <p>No hay logo configurado</p>
                </div>
              </div>
            )}
          </div>

          <input
            ref={fileInputRef}
            type="file"
            accept="image/*"
            onChange={handleLogoUpload}
            className="hidden"
          />

          <button
            type="button"
            onClick={() => fileInputRef.current?.click()}
            disabled={uploadingLogo}
            className="btn btn-primary w-full"
          >
            {uploadingLogo ? (
              <>
                <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                Subiendo...
              </>
            ) : (
              <>
                <Upload className="w-4 h-4 mr-2" />
                Subir Logo
              </>
            )}
          </button>

          <p className="text-sm text-gray-500 mt-2">
            Formatos: JPG, PNG, GIF, SVG. Tamaño máximo: 5MB
          </p>
        </div>

        {/* Colores */}
        <div className="card">
          <h2 className="text-xl font-semibold text-gray-900 mb-4">Colores del Sistema</h2>
          
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Nombre de la Empresa
              </label>
              <input
                type="text"
                {...register('companyName', { required: 'El nombre es requerido' })}
                className="input"
                placeholder="Sistema de Consentimientos"
              />
              {errors.companyName && (
                <p className="text-red-500 text-sm mt-1">{errors.companyName.message}</p>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Color Primario
              </label>
              <div className="flex items-center space-x-3">
                <input
                  type="color"
                  {...register('primaryColor')}
                  className="h-10 w-20 rounded border border-gray-300 cursor-pointer"
                />
                <input
                  type="text"
                  {...register('primaryColor')}
                  className="input flex-1"
                  placeholder="#3B82F6"
                />
              </div>
              <p className="text-sm text-gray-500 mt-1">
                Color principal de la aplicación (botones, enlaces, etc.)
              </p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Color Secundario
              </label>
              <div className="flex items-center space-x-3">
                <input
                  type="color"
                  {...register('secondaryColor')}
                  className="h-10 w-20 rounded border border-gray-300 cursor-pointer"
                />
                <input
                  type="text"
                  {...register('secondaryColor')}
                  className="input flex-1"
                  placeholder="#10B981"
                />
              </div>
              <p className="text-sm text-gray-500 mt-1">
                Color secundario para elementos complementarios
              </p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Color de Acento
              </label>
              <div className="flex items-center space-x-3">
                <input
                  type="color"
                  {...register('accentColor')}
                  className="h-10 w-20 rounded border border-gray-300 cursor-pointer"
                />
                <input
                  type="text"
                  {...register('accentColor')}
                  className="input flex-1"
                  placeholder="#F59E0B"
                />
              </div>
              <p className="text-sm text-gray-500 mt-1">
                Color para destacar elementos importantes
              </p>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="btn btn-primary w-full"
            >
              {loading ? (
                <>
                  <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                  Guardando...
                </>
              ) : (
                <>
                  <Save className="w-4 h-4 mr-2" />
                  Guardar Cambios
                </>
              )}
            </button>
          </form>
        </div>
      </div>

      {/* Vista Previa */}
      <div className="card mt-6">
        <h2 className="text-xl font-semibold text-gray-900 mb-4">Vista Previa</h2>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <p className="text-sm text-gray-600 mb-2">Botón Primario</p>
            <button className="btn btn-primary w-full">
              Ejemplo de Botón
            </button>
          </div>

          <div>
            <p className="text-sm text-gray-600 mb-2">Color Secundario</p>
            <div
              className="h-10 rounded-lg flex items-center justify-center text-white font-medium"
              style={{ backgroundColor: settings.secondaryColor }}
            >
              Secundario
            </div>
          </div>

          <div>
            <p className="text-sm text-gray-600 mb-2">Color de Acento</p>
            <div
              className="h-10 rounded-lg flex items-center justify-center text-white font-medium"
              style={{ backgroundColor: settings.accentColor }}
            >
              Acento
            </div>
          </div>
        </div>

        <p className="text-sm text-gray-500 mt-4">
          Los cambios se aplicarán inmediatamente en toda la aplicación
        </p>
      </div>
    </div>
  );
}
