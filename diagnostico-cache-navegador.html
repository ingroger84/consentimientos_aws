<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Diagn√≥stico de Cach√© - v30.2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 20px;
        }
        
        h2 {
            color: #1f2937;
            font-size: 24px;
            margin: 20px 0 15px 0;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .alert-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }
        
        .alert-success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }
        
        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }
        
        .btn {
            display: inline-block;
            padding: 15px 30px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .info-box {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .version-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            padding: 30px;
            margin: 20px 0;
            border-radius: 12px;
        }
        
        .version-old {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .version-new {
            background: #d1fae5;
            color: #065f46;
        }
        
        .steps {
            counter-reset: step-counter;
            list-style: none;
        }
        
        .steps li {
            counter-increment: step-counter;
            padding: 15px;
            margin-bottom: 12px;
            background: #f9fafb;
            border-radius: 8px;
            position: relative;
            padding-left: 60px;
        }
        
        .steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        #diagnosticResult {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîç Diagn√≥stico de Cach√© del Navegador</h1>
            
            <div class="alert alert-warning">
                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                <div>
                    <strong>Est√°s viendo la versi√≥n 30.2.0</strong><br>
                    Esta herramienta te ayudar√° a identificar y limpiar la cach√© para ver la versi√≥n 30.2.1
                </div>
            </div>

            <div id="diagnosticResult"></div>

            <h2>üìä Versi√≥n Actual Detectada</h2>
            <div id="versionDisplay" class="version-display version-old">
                Detectando...
            </div>

            <h2>üîß Soluciones Paso a Paso</h2>
            
            <div class="card" style="background: #fef3c7; border: 2px solid #f59e0b;">
                <h3 style="color: #92400e; margin-bottom: 15px;">‚ö° Soluci√≥n R√°pida (Recomendada)</h3>
                <ol class="steps">
                    <li>
                        <strong>Cierra TODAS las pesta√±as del sitio</strong><br>
                        Cierra todas las ventanas de admin.archivoenlinea.com
                    </li>
                    <li>
                        <strong>Limpia la cach√© del navegador</strong><br>
                        <div class="info-box">
                            Windows/Linux: Ctrl + Shift + Delete<br>
                            Mac: Cmd + Shift + Delete
                        </div>
                        Selecciona "Im√°genes y archivos en cach√©" y haz clic en "Borrar datos"
                    </li>
                    <li>
                        <strong>Abre una ventana de inc√≥gnito</strong><br>
                        <div class="info-box">
                            Windows/Linux: Ctrl + Shift + N<br>
                            Mac: Cmd + Shift + N
                        </div>
                    </li>
                    <li>
                        <strong>Ve al sitio en modo inc√≥gnito</strong><br>
                        <a href="https://admin.archivoenlinea.com" target="_blank" class="btn">
                            Abrir en Nueva Ventana
                        </a>
                    </li>
                </ol>
            </div>

            <h2>üõ†Ô∏è Herramientas de Limpieza</h2>
            
            <button onclick="clearAllCaches()" class="btn btn-danger">
                üßπ Limpiar TODO (Agresivo)
            </button>
            
            <button onclick="clearServiceWorkers()" class="btn btn-danger">
                üîÑ Limpiar Service Workers
            </button>
            
            <button onclick="reloadHard()" class="btn btn-success">
                ‚ôªÔ∏è Recarga Forzada
            </button>
            
            <button onclick="checkVersion()" class="btn">
                üîç Verificar Versi√≥n
            </button>

            <h2>üì± Instrucciones por Navegador</h2>
            
            <div class="card" style="background: #f9fafb;">
                <h3>Chrome / Edge:</h3>
                <ol class="steps">
                    <li>Presiona <strong>Ctrl + Shift + Delete</strong></li>
                    <li>Selecciona "Im√°genes y archivos en cach√©"</li>
                    <li>Selecciona "Todo el tiempo"</li>
                    <li>Haz clic en "Borrar datos"</li>
                    <li>Cierra y abre el navegador</li>
                </ol>
            </div>

            <div class="card" style="background: #f9fafb;">
                <h3>Firefox:</h3>
                <ol class="steps">
                    <li>Presiona <strong>Ctrl + Shift + Delete</strong></li>
                    <li>Selecciona "Cach√©"</li>
                    <li>Selecciona "Todo"</li>
                    <li>Haz clic en "Limpiar ahora"</li>
                    <li>Cierra y abre el navegador</li>
                </ol>
            </div>

            <div class="card" style="background: #f9fafb;">
                <h3>Safari (Mac):</h3>
                <ol class="steps">
                    <li>Presiona <strong>Cmd + Option + E</strong> (vaciar cach√©)</li>
                    <li>O ve a Safari ‚Üí Preferencias ‚Üí Avanzado</li>
                    <li>Activa "Mostrar men√∫ Desarrollo"</li>
                    <li>Desarrollo ‚Üí Vaciar cach√©s</li>
                    <li>Cierra y abre el navegador</li>
                </ol>
            </div>

            <h2>üîç Informaci√≥n de Depuraci√≥n</h2>
            <div id="debugInfo" class="info-box">
                Cargando informaci√≥n...
            </div>

            <h2>‚ùì ¬øPor qu√© sigo viendo la versi√≥n antigua?</h2>
            <div class="alert alert-warning">
                <span style="font-size: 24px;">üí°</span>
                <div>
                    <strong>Razones comunes:</strong><br>
                    1. El navegador tiene archivos JS antiguos en cach√©<br>
                    2. Service Workers est√°n sirviendo versiones antiguas<br>
                    3. El navegador no ha recargado completamente<br>
                    4. Hay m√∫ltiples pesta√±as abiertas del sitio<br>
                    5. El navegador est√° en modo "offline"
                </div>
            </div>

            <h2>‚úÖ Verificaci√≥n Final</h2>
            <div class="alert alert-success">
                <span style="font-size: 24px;">‚úì</span>
                <div>
                    <strong>Despu√©s de limpiar la cach√©:</strong><br>
                    1. Abre DevTools (F12)<br>
                    2. Ve a Console<br>
                    3. Escribe: <code>console.log(window.APP_VERSION)</code><br>
                    4. Debe mostrar: <strong>"30.2.1 - 2026-02-08"</strong>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Detectar versi√≥n actual
        function checkVersion() {
            const versionDisplay = document.getElementById('versionDisplay');
            const diagnosticResult = document.getElementById('diagnosticResult');
            
            // Intentar obtener la versi√≥n de window.APP_VERSION
            if (window.APP_VERSION) {
                const version = window.APP_VERSION;
                versionDisplay.textContent = version;
                
                if (version.includes('30.2.1')) {
                    versionDisplay.className = 'version-display version-new';
                    diagnosticResult.innerHTML = `
                        <div class="alert alert-success">
                            <span style="font-size: 24px;">‚úÖ</span>
                            <div>
                                <strong>¬°√âxito!</strong><br>
                                Est√°s viendo la versi√≥n correcta: ${version}
                            </div>
                        </div>
                    `;
                } else {
                    versionDisplay.className = 'version-display version-old';
                    diagnosticResult.innerHTML = `
                        <div class="alert alert-error">
                            <span style="font-size: 24px;">‚ùå</span>
                            <div>
                                <strong>Versi√≥n Antigua Detectada</strong><br>
                                Est√°s viendo: ${version}<br>
                                Deber√≠as ver: 30.2.1 - 2026-02-08
                            </div>
                        </div>
                    `;
                }
            } else {
                versionDisplay.textContent = 'No se pudo detectar la versi√≥n';
                versionDisplay.className = 'version-display version-old';
                diagnosticResult.innerHTML = `
                    <div class="alert alert-error">
                        <span style="font-size: 24px;">‚ùå</span>
                        <div>
                            <strong>Error</strong><br>
                            No se pudo detectar window.APP_VERSION<br>
                            Esto indica que los archivos JS no se cargaron correctamente
                        </div>
                    </div>
                `;
            }
            
            updateDebugInfo();
        }

        // Limpiar todas las cach√©s
        async function clearAllCaches() {
            try {
                // Limpiar cach√© de la API de Cache
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(
                        cacheNames.map(cacheName => caches.delete(cacheName))
                    );
                    console.log('‚úÖ Cach√©s eliminadas:', cacheNames);
                }
                
                // Limpiar localStorage
                localStorage.clear();
                console.log('‚úÖ localStorage limpiado');
                
                // Limpiar sessionStorage
                sessionStorage.clear();
                console.log('‚úÖ sessionStorage limpiado');
                
                alert('‚úÖ Cach√© limpiada completamente.\n\nAhora:\n1. Cierra TODAS las pesta√±as del sitio\n2. Cierra el navegador completamente\n3. Abre el navegador de nuevo\n4. Ve a admin.archivoenlinea.com');
                
            } catch (error) {
                console.error('Error limpiando cach√©:', error);
                alert('‚ùå Error al limpiar la cach√©. Intenta limpiarla manualmente desde la configuraci√≥n del navegador.');
            }
        }

        // Limpiar Service Workers
        async function clearServiceWorkers() {
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('‚úÖ Service Worker eliminado:', registration);
                    }
                    alert('‚úÖ Service Workers eliminados.\n\nAhora recarga la p√°gina con Ctrl+Shift+R');
                } else {
                    alert('‚ÑπÔ∏è Este navegador no tiene Service Workers activos');
                }
            } catch (error) {
                console.error('Error eliminando Service Workers:', error);
                alert('‚ùå Error al eliminar Service Workers');
            }
        }

        // Recarga forzada
        function reloadHard() {
            // Limpiar cach√© y recargar
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            
            // Recargar sin cach√©
            window.location.reload(true);
        }

        // Actualizar informaci√≥n de depuraci√≥n
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            
            const info = {
                'Navegador': navigator.userAgent,
                'URL Actual': window.location.href,
                'Protocolo': window.location.protocol,
                'Host': window.location.host,
                'Tiene Service Worker': 'serviceWorker' in navigator ? 'S√≠' : 'No',
                'Tiene Cache API': 'caches' in window ? 'S√≠' : 'No',
                'Online': navigator.onLine ? 'S√≠' : 'No',
                'Cookies Habilitadas': navigator.cookieEnabled ? 'S√≠' : 'No',
                'window.APP_VERSION': window.APP_VERSION || 'No definido',
            };
            
            let html = '';
            for (const [key, value] of Object.entries(info)) {
                html += `<strong>${key}:</strong> ${value}<br>`;
            }
            
            debugInfo.innerHTML = html;
        }

        // Ejecutar al cargar
        window.addEventListener('load', () => {
            checkVersion();
            updateDebugInfo();
            
            // Verificar cada 5 segundos
            setInterval(checkVersion, 5000);
        });

        // Detectar cuando se recarga la p√°gina
        window.addEventListener('beforeunload', () => {
            console.log('üîÑ P√°gina recarg√°ndose...');
        });
    </script>
</body>
</html>
